## ì˜ì†ì„± ì»¨í…ìŠ¤íŠ¸ 1

**JPAì—ì„œ ê°€ì¥ ì¤‘ìš”í•œ 2ê°€ì§€**

- ê°ì²´ì™€ ê´€ê³„í˜• ë°ì´í„°ë² ì´ìŠ¤ ë§¤í•‘í•˜ê¸°
  (Object Relational Mapping)
- ì˜ì†ì„± ì»¨í…ìŠ¤íŠ¸

### ì—”í‹°í‹° ë§¤ë‹ˆì € íŒ©í† ë¦¬ì™€ ì—”í‹°í‹° ë§¤ë‹ˆì €

<img src="https://github.com/iieunji023/jpa-with-spring-boot-basic/blob/main/images/ì—”í‹°í‹°ë§¤ë‹ˆì €.png" width="400">

- ê³ ê°ì˜ ìš”ì²­ì´ ìˆì„ ë•Œë§ˆë‹¤ EntitiyManagerFactoryì—ì„œ EntityManagerë¥¼ ìƒì„±í•œë‹¤
- EntityManagerëŠ” ë‚´ë¶€ì ìœ¼ë¡œ ë°ì´í„°ë² ì´ìŠ¤ ì»¤ë„¥ì…˜ì„ ì‚¬ìš©í•´ì„œ DBë¥¼ ì‚¬ìš©í•˜ê²Œ ëœë‹¤

### ì˜ì†ì„± ì»¨í…ìŠ¤íŠ¸

- JPAë¥¼ ì´í•´í•˜ëŠ”ë° ê°€ì¥ ì¤‘ìš”í•œ ìš©ì–´
- â€œì—”í‹°í‹°ë¥¼ ì˜êµ¬ ì €ì¥í•˜ëŠ” í™˜ê²½â€ì´ë¼ëŠ” ëœ»
- `EntityManager.persist(entity)`
  - ì—”í‹°í‹° ë§¤ë‹ˆì €ë¥¼ í†µí•´ì„œ ì˜ì†ì„± ì»¨í…ìŠ¤íŠ¸ì— ì ‘ê·¼
  - `persist()` ë©”ì„œë“œëŠ” dbì— ì €ì¥í•˜ëŠ” ê²ƒì´ ì•„ë‹ˆë¼ ì—”í‹°í‹°ë¥¼ ì˜ì†ì„± ì»¨í…ìŠ¤íŠ¸ë¼ëŠ” ê³³ì— ì €ì¥í•œë‹¤ëŠ” ì˜ë¯¸

### ì—”í‹°í‹°ì˜ ìƒëª…ì£¼ê¸°

- ë¹„ì˜ì†(new/transient)
  - ì˜ì†ì„± ì»¨í…ìŠ¤íŠ¸ì™€ ì „í˜€ ê´€ê³„ê°€ ì—†ëŠ” ìƒˆë¡œìš´ ìƒíƒœ
- ì˜ì†(managed)
  - ì˜ì†ì„± ì»¨í…ìŠ¤íŠ¸ì— ê´€ë¦¬ë˜ëŠ” ìƒíƒœ
- ì¤€ì˜ì†(detached)
  - ì˜ì†ì„± ì»¨í…ìŠ¤íŠ¸ì— ì €ì¥ë˜ì—ˆë‹¤ê°€ ë¶„ë¦¬ëœ ìƒíƒœ
- ì‚­ì œ(removed)
  - ì‚­ì œëœ ìƒíƒœ
```
// ë¹„ì˜ì†
Member member = new Member();
member.setId(100L);
member.setName("HelloJPA");

// ì˜ì†
System.out.println("BEFORE");
em.persist(member);
System.out.println("AFTER");
```

- ì˜ì†ìƒíƒœë¼ í•´ì„œ ë””ë¹„ì— ì¿¼ë¦¬ ë‚ ë¼ê°€ëŠ” ê²ƒ ì•„ë‹˜
- commit ì‹œì ì— ë””ë¹„ë¡œ ë‚ ë¼ê°
- ì¶œë ¥ ê²°ê³¼
  ```
  BEFORE
  AFTER
  Hibernate:
  /* insert for
  hellojpa.Member */insert
  into
  Member (name, id)
  values
  (?, ?)
    ```

<br>

## ì˜ì†ì„± ì»¨í…ìŠ¤íŠ¸ 2

```
ğŸ’¡ ì˜ì†ì„± ì»¨í…ŒìŠ¤íŠ¸ì˜ ì´ì 
- 1ì°¨ ìºì‹œ
- ë™ì¼ì„±(identity) ë³´ì¥
- íŠ¸ëœì­ì…˜ì„ ì§€ì›í•˜ëŠ” ì“°ê¸° ì§€ì—°
(transactional write-behind)
- ë³€ê²½ ê°ì§€(Dirty Checking)
- ì§€ì—° ë¡œë”©(Lazy Loading)
```

### 1ì°¨ ìºì‹œì—ì„œ ì¡°íšŒ

<img src="https://github.com/iieunji023/jpa-with-spring-boot-basic/blob/main/images/ì˜ì†ì»¨í…ìŠ¤íŠ¸.png" width="400">

<details>
      <summary>ì½”ë“œ</summary>

    // ë¹„ì˜ì†
    Member member = new Member();
    member.setId(101L);
    member.setName("Hello101");
    
    // ì˜ì†
    System.out.println("BEFORE");
    em.persist(member);
    System.out.println("AFTER");
    
    Member findMember = em.find(Member.class, 101L);
    System.out.println("findMember.getId() = " + findMember.getId());
    System.out.println("findMember.getName() = " + findMember.getName());
    
    tx.commit();

</details>

- ì¶œë ¥ê²°ê³¼

    ```
    BEFORE
    AFTER
    findMember.getId() = 101
    findMember.getName() = Hello101
    Hibernate: 
        /* insert for
            hellojpa.Member */insert 
        into
            Member (name, id) 
        values
            (?, ?)
    ```

  - findMemberì— ê°’ì€ ì°íˆì§€ë§Œ selectë¬¸ ì—†ìŒ..!!
  - `em.persist(member);` ì— ì €ì¥ì„ í•˜ëŠ” ê²ƒì€ 1ì°¨ ìºì‹œì— ì €ì¥í•˜ëŠ” ê²ƒ!
  - ë”°ë¼ì„œ, `em.find(Member.class, 101L);` ë¥¼ í†µí•´ ì¡°íšŒí•˜ëŠ” ê²ƒì€ DBë¥¼ ì¡°íšŒí•˜ëŠ” ê²ƒì´ ì•„ë‹ˆë¼ 1ì°¨ ìºì‹œì— ìˆëŠ” ê²ƒì„ ì¡°íšŒí•˜ëŠ” ê²ƒ!

<img src="https://github.com/iieunji023/jpa-with-spring-boot-basic/blob/main/images/ì˜ì†ì»¨í…ìŠ¤íŠ¸1.png" width="400">

<details>
      <summary>ì½”ë“œ</summary>

    Member findMember1 = em.find(Member.class, 101L);
    Member findMember2 = em.find(Member.class, 101L);
    
    tx.commit();

</details>

- ì¶œë ¥ ê²°ê³¼

    ```
    Hibernate: 
        select
            m1_0.id,
            m1_0.name 
        from
            Member m1_0 
        where
            m1_0.id=?
    ```

  - ë‹¤ì‹œ ì¡°íšŒí•˜ê²Œ ë˜ë©´ ì—”í‹°í‹° ë§¤ë‹ˆì €ê°€ ìƒˆë¡œ ìƒì„±
  - ì²«ë²ˆì§¸ë§Œ selectë¬¸ì´ ë‚˜ì™€ì•¼ í•¨
  - DBì—ì„œ ì¡°íšŒëœ ê°’ë“¤ì´ ë‹¤ì‹œ 1ì°¨ ìºì‹œì— ì €ì¥ë˜ê¸° ë•Œë¬¸ì— 2ë²ˆì§¸ ì¡°íšŒëœ ê²ƒì€ 1ì°¨ìºì‹œì—ì„œ ì¡°íšŒë˜ëŠ” ê²ƒ

ì˜ì† ì—”í‹°í‹°ì˜ ë™ì¼ì„± ë³´ì¥
<details>
      <summary>ì½”ë“œ</summary>

    Member findMember1 = em.find(Member.class, 101L);
    Member findMember2 = em.find(Member.class, 101L);
    
    System.out.println("result = " + (findMember1 == findMember2));

</details>

- ì¶œë ¥ ê²°ê³¼

    ```
    Hibernate: 
        select
            m1_0.id,
            m1_0.name 
        from
            Member m1_0 
        where
            m1_0.id=?
    result = true
    ```

  - 1ì°¨ ìºì‹œë¡œ ë°˜ë³µ ê°€ëŠ¥í•œ ì½ê¸°(REPEATABLE READ) ë“±ê¸‰ì˜ íŠ¸ëœì­ì…˜ ê²©ë¦¬ ìˆ˜ì¤€ì„ ë°ì´í„°ë² ì´ìŠ¤ê°€ ì•„ë‹Œ ì• í”Œë¦¬ì¼€ì´ì…˜ ì°¨ì›ì—ì„œ ì œê³µ

### ì—”í‹°í‹° ë“±ë¡ (íŠ¸ëœì­ì…˜ì„ ì§€ì›í•˜ëŠ” ì“°ê¸° ì§€ì—°)

<img src="https://github.com/iieunji023/jpa-with-spring-boot-basic/blob/main/images/ì˜ì†ì»¨í…ìŠ¤íŠ¸2.png" width="400"><br>
<img src="https://github.com/iieunji023/jpa-with-spring-boot-basic/blob/main/images/ì˜ì†ì»¨í…ìŠ¤íŠ¸3.png" width="400">

- `em.persist(memberA);`ë¥¼ í–ˆì„ ë•Œ, DBì— insertë˜ëŠ” ê²ƒì´ ì•„ë‹ˆë¼ 1ì°¨ ìºì‹œì— ì €ì¥ëœë‹¤.
- `em.persist(memberB);`ë¥¼ í–ˆì„ ë•Œë„, memberA, memberB ëª¨ë‘ DBì— ì €ì¥ë˜ëŠ” ê²Œ ì•„ë‹ˆë¼ 1ì°¨ ìºì‹œì— ì €ì¥ëœë‹¤.

<details>
      <summary>ì½”ë“œ</summary>

    tx.begin();

    // ì˜ì†
    Member member1 = new Member(150L, "A");
    Member member2 = new Member(160L, "B");
    
    em.persist(member1);
    em.persist(member2);
    
    System.out.println("========================");
    
    tx.commit();

</details>

- ì¶œë ¥ ê²°ê³¼

    ```
    ========================
    Hibernate: 
        /* insert for
            hellojpa.Member */insert 
        into
            Member (name, id) 
        values
            (?, ?)
    Hibernate: 
        /* insert for
            hellojpa.Member */insert 
        into
            Member (name, id) 
        values
            (?, ?)
    ```

  - `System.out.println("========================");` ì¶œë ¥ ë©”ì„¸ì§€ ì´í›„ì— insertë¨
  - persist() ë‹¨ê³„ì—ì„œëŠ” INSERT SQLì„ ë°ì´í„°ë² ì´ìŠ¤ì— ë³´ë‚´ì§€ ì•ŠìŒ
  - commitì‹œì ì— ë°ì´í„°ë² ì´ìŠ¤ì— INSERT SQLì„ ë³´ëƒ„

### ì—”í‹°í‹° ìˆ˜ì • (ë³€ê²½ ê°ì§€)
<details>
      <summary>ì½”ë“œ</summary>

    Member member = em.find(Member.class, 150L);
    // ë°ì´í„° ê°’ ë³€ê²½
    member.setName("zzzz");

</details>

- ì¶œë ¥ ê²°ê³¼

    ```
    Hibernate: 
        select
            m1_0.id,
            m1_0.name 
        from
            Member m1_0 
        where
            m1_0.id=?
    ========================
    Hibernate: 
        /* update
            for hellojpa.Member */update Member 
        set
            name=? 
        where
            id=?
    ```

  - em.update(member), em.persist(member);ë¥¼ í•´ì•¼ í•  ê²ƒ ê°™ì§€ë§Œ! í•˜ì§€ ì•Šì•„ë„ ìˆ˜ì •ë¨
  - JPAëŠ” ê°’ì´ ë³€ê²½ëœ ê²ƒì„ ì¸ì§€í•˜ë©´ ìë™ìœ¼ë¡œ ë³€ê²½í•´ì¤€ë‹¤

<img src="https://github.com/iieunji023/jpa-with-spring-boot-basic/blob/main/images/ì˜ì†ì»¨í…ìŠ¤íŠ¸4.png" width="400"><br>

1. commit â†’ ë‚´ë¶€ì ìœ¼ë¡œ flush() í˜¸ì¶œ
2. ì—”í‹°í‹°ì™€ ìŠ¤ëƒ…ìƒ·ì„ ë¹„êµí•œë‹¤
  - ìŠ¤ëƒ…ìƒ·: ê°’ì„ ì½ì–´ì˜¨ ìµœì´ˆ ì‹œì , 1ì°¨ ìºì‹œì— ë“¤ì–´ì˜¨ ìƒíƒœ
3. ì—”í‹°í‹°ì™€ ìŠ¤ëƒ…ìƒ·ì´ ë‹¤ë¥¸ ê²½ìš°, ê°’ì´ ë³€ê²½ëœ ê²½ìš° ì—…ë°ì´íŠ¸ ì¿¼ë¦¬ë¥¼ ì“°ê¸° ì§€ì—° SQL ì €ì¥ì†Œì— ë§Œë“¤ì–´ë‘”ë‹¤
4. ì´í›„ ì—…ë°ì´íŠ¸ ì¿¼ë¦¬ë¥¼ ë°ì´í„°ë² ì´ìŠ¤ì— ë°˜ì˜í•˜ê³  ì»¤ë°‹

ğŸ’¡ ë§Œì•½ ê°’ì´ ë³€ê²½ë  ë•Œë§Œ ì—…ë°ì´íŠ¸í•˜ê³  ê°’ì´ ë³€ê²½ë˜ì§€ ì•ŠëŠ”ë‹¤ë©´ ì¡°íšŒë§Œ í•˜ê³  ì‹¶ë‹¤ë©´

```
if(member.getName().equals("zzzz")){
   em.persist(member);
}
```

- ì´ëŸ¬í•œ ì½”ë“œë¥¼ ì ìœ¼ë ¤ í•  ê²ƒì´ë‹¤
- ê·¸ëŸ¬ë‚˜ JPAë¥¼ ì‚¬ìš©í•˜ë©´ ì´ëŸ° ì½”ë“œë¥¼ ì‘ì„±í•˜ì§€ ì•Šì•„ë„ ê°’ì´ ë³€ê²½ë˜ë©´ ì—…ë°ì´íŠ¸í•´ì¤€ë‹¤!

### ì—”í‹°í‹° ì‚­ì œ
```
//ì‚­ì œ ëŒ€ìƒ ì—”í‹°í‹° ì¡°íšŒ  
Member memberA = em.find(Member.class, â€œmemberA");
em.remove(memberA); //ì—”í‹°í‹° ì‚­ì œ
```

<br>

## í”ŒëŸ¬ì‹œ

- ì˜ì†ì„± ì»¨í…ìŠ¤íŠ¸ì˜ ë³€ê²½ë‚´ìš©ì„ ë°ì´í„°ë² ì´ìŠ¤ì— ë°˜ì˜
- ì˜ì†ì„± ì»¨í…ìŠ¤íŠ¸ì˜ í˜„ì¬ ë³€ê²½ ì‚¬ì–‘ê³¼ ê·¸ ë°ì´í„°ë² ì´ìŠ¤ë¥¼ ë§ì¶”ëŠ” ì‘ì—…
- ì˜ì†ì„± ì»¨í…ìŠ¤íŠ¸ì˜ ì¿¼ë¦¬ë“¤ì„ DBì— ë‚ ë ¤ì£¼ëŠ” ê²ƒ

### í”ŒëŸ¬ì‹œ ë°œìƒ

- ë°ì´í„°ë² ì´ìŠ¤ê°€ ì»¤ë°‹ë˜ë©´ í”ŒëŸ¬ì‹œê°€ ìë™ìœ¼ë¡œ ë°œìƒ
- ë³€ê²½ ê°ì§€
- ìˆ˜ì •ëœ ì—”í‹°í‹° ì“°ê¸° ì§€ì—° SQL ì €ì¥ì†Œì— ë“±ë¡
- ì“°ê¸° ì§€ì—° SQL ì €ì¥ì†Œì˜ ì¿¼ë¦¬ë¥¼ ë°ì´í„°ë² ì´ìŠ¤ì— ì „ì†¡
  (ë“±ë¡, ìˆ˜ì •, ì‚­ì œ ì¿¼ë¦¬)

### ì˜ì†ì„± ì»¨í…ìŠ¤íŠ¸ë¥¼ í”ŒëŸ¬ì‹œí•˜ëŠ” ë°©ë²•

- em.flush() - ì§ì ‘ í˜¸ì¶œ
- íŠ¸ëœì­ì…˜ ì»¤ë°‹ - í”ŒëŸ¬ì‹œ ìë™ í˜¸ì¶œ
- JPQL ì¿¼ë¦¬ ì‹¤í–‰ - í”ŒëŸ¬ì‹œ ìë™ í˜¸ì¶œ

<details>
      <summary>ì½”ë“œ</summary>

    Member member = new Member(200L, "member200");
    em.persist(member);
    
    em.flush();
    
    System.out.println("========================");
    tx.commit();

</details>

- ì¶œë ¥ ê²°ê³¼

    ```
    Hibernate: 
        /* insert for
            hellojpa.Member */insert 
        into
            Member (name, id) 
        values
            (?, ?)
    ========================
    ```

  - `System.out.println("========================");` ì¶œë ¥ë˜ê¸° ì „ insertë¨
  - ì¦‰ ì»¤ë°‹ ì „ì— em.flush();ë¥¼ í†µí•´ ê°•ì œë¡œ DBì— INSERT SQLë¬¸ì„ ë‚ ë¦¼
  - í”ŒëŸ¬ì‰¬ë¥¼ í•´ë„ 1ì°¨ ìºì‹œëŠ” ì§€ì›Œì§€ì§€ ì•Šê³  ë‚¨ì•„ìˆìŒ!

### JPQL ì¿¼ë¦¬ ì‹¤í–‰ì‹œ í”ŒëŸ¬ì‹œê°€ ìë™ìœ¼ë¡œ í˜¸ì¶œë˜ëŠ” ì´ìœ 
```
em.persist(memberA);
em.persist(memberB);
em.persist(memberC);
 //ì¤‘ê°„ì— JPQL ì‹¤í–‰
query = em.createQuery("select m from Member m", Member.class);
List<Member> members= query.getResultList();
```

- ì´ ê²½ìš° JPQLë¥¼ í†µí•´ ì¿¼ë¦¬ë¥¼ ì¡°íšŒí•  ë•Œ persist() ìƒíƒœì´ë¯€ë¡œ 1ì°¨ ìºì‹œì—ë§Œ ì €ì¥ë˜ì–´ ìˆìŒ
- ê·¸ë˜ì„œ ë°ì´í„°ë² ì´ìŠ¤ì—ëŠ” ë°˜ì˜ì´ ë˜ì§€ ì•Šì•˜ê¸° ë•Œë¬¸ì— ì¡°íšŒí•˜ì§€ ëª»í•˜ëŠ” ë¬¸ì œ ë°œìƒ

### í”ŒëŸ¬ì‹œ ëª¨ë“œ ì˜µì…˜

```jsx
em.setFlushMode(FlushModeType.COMMIT)
```

- FlushModeType.AUTO
  - ì»¤ë°‹ì´ë‚˜ ì¿¼ë¦¬ë¥¼ ì‹¤í–‰í•  ë•Œ í”ŒëŸ¬ì‹œ(ê¸°ë³¸ê°’)
- FlushModeType.COMMIT
  - ì»¤ë°‹í•  ë•Œë§Œ í”ŒëŸ¬ì‹œ

### ì •ë¦¬

- í”ŒëŸ¬ì‹œëŠ”
- ì˜ì†ì„± ì»¨í…ìŠ¤íŠ¸ë¥¼ ë¹„ìš°ì§€ ì•ŠìŒ
- ì˜ì†ì„± ì»¨í…ìŠ¤íŠ¸ì˜ ë³€ê²½ë‚´ìš©ì„ ë°ì´í„°ë² ì´ìŠ¤ì— ë™ê¸°í™”
- íŠ¸ëœì­ì…˜ì´ë¼ëŠ” ì‘ì—… ë‹¨ìœ„ê°€ ì¤‘ìš” â†’ ì»¤ë°‹ ì§ì „ì—ë§Œ ë™ê¸°í™”í•˜ë©´ ë¨

<br>

## ì¤€ì˜ì† ìƒíƒœ

- ì˜ì† â†’ ì¤€ì˜ì†
- ì˜ì† ìƒíƒœì˜ ì—”í‹°í‹°ê°€ ì˜ì†ì„± ì»¨í…ìŠ¤íŠ¸ì—ì„œ ë¶„ë¦¬(detached)
- ì˜ì†ì„± ì»¨í…ìŠ¤íŠ¸ê°€ ì œê³µí•˜ëŠ” ê¸°ëŠ¥ì„ ì‚¬ìš© ëª»í•¨

<details>
      <summary>ì½”ë“œ</summary>

    Member member = em.find(Member.class, 150L);
    member.setName("aaaa");
    
    em.detach(member);
    
    System.out.println("========================");
    tx.commit();

</details>

- ì¶œë ¥ ê²°ê³¼

    ```
    Hibernate: 
        select
            m1_0.id,
            m1_0.name 
        from
            Member m1_0 
        where
            m1_0.id=?
    ========================
    ```

  - íŠ¸ëœì­ì…˜ ì»¤ë°‹ì„ í•  ë•Œ ì•„ë¬´ì¼ì´ ì¼ì–´ë‚˜ì§€ ì•ŠìŒ
    (selectë§Œ ë°œìƒí•  ë¿, update ë˜ì§€ ì•ŠìŒ)
  - ì˜ì†ì„± ì»¨í…ìŠ¤íŠ¸ì—ì„œ í†µìœ¼ë¡œ ë¹ ì ¸ë²„ë ¸ê¸° ë•Œë¬¸!
  - JPA ê¸°ëŠ¥ì„ ì œê³µí•´ì£¼ì§€ ì•ŠìŒ!!

### ì¤€ì˜ì† ìƒíƒœë¡œ ë§Œë“œëŠ” ë°©ë²•

- em.detach(entity)
  - íŠ¹ì • ì—”í‹°í‹°ë§Œ ì¤€ì˜ì† ìƒíƒœë¡œ ì „í™˜
- em.clear()
  - ì˜ì†ì„± ì»¨í…ìŠ¤íŠ¸ë¥¼ ì™„ì „íˆ ì´ˆê¸°í™”
- em.close()
  - ì˜ì†ì„± ì»¨í…ìŠ¤íŠ¸ë¥¼ ì¢…ë£Œ